---
import "../styles/global.css";
import DecisionField from "../components/system/DecisionField.astro";

interface Props {
  title?: string;
}

const { title = "Aurora" } = Astro.props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="La era de la evidencia comenzÃ³." />
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body data-state="hero">
    <DecisionField />

    <header class="site-header">
      <div class="container-base site-header-inner">
        <a href="/" class="site-brand">Aurora</a>
        <a href="#contacto" class="site-contact-link">Contactar</a>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer id="contacto" class="site-footer">
      Aurora
    </footer>

    <script>
      const STATE_BY_SECTION = {
        hero: "hero",
        change: "change",
        rupture: "rupture",
        "what-aurora": "stabilized",
        capabilities: "capability-core",
        binary: "binary-before",
        "demo-cta": "demo-standard",
        demo: "demo-standard",
      };

      const trackedSections = Object.keys(STATE_BY_SECTION)
        .map((id) => document.getElementById(id))
        .filter(Boolean);

      const setState = (nextState) => {
        if (!nextState) return;
        if (document.body.dataset.state !== nextState) {
          document.body.dataset.state = nextState;
        }
      };

      if (trackedSections.length === 0 || typeof IntersectionObserver === "undefined") {
        setState("hero");
      } else {
        const visibility = new Map();
        const fallbackState = STATE_BY_SECTION[trackedSections[0].id] ?? "hero";

        const applyState = () => {
          let bestScore = -1;
          let bestState = fallbackState;

          for (let i = 0; i < trackedSections.length; i += 1) {
            const section = trackedSections[i];
            const ratio = visibility.get(section) ?? 0;
            const score = ratio + (trackedSections.length - i) * 0.0001;
            if (score > bestScore) {
              bestScore = score;
              bestState = STATE_BY_SECTION[section.id] ?? bestState;
            }
          }

          setState(bestState);
        };

        const observer = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              visibility.set(entry.target, entry.isIntersecting ? entry.intersectionRatio : 0);
            }
            applyState();
          },
          {
            root: null,
            rootMargin: "-20% 0px -20% 0px",
            threshold: [0, 0.16, 0.32, 0.52, 0.68, 0.84],
          }
        );

        trackedSections.forEach((section) => {
          visibility.set(section, 0);
          observer.observe(section);
        });

        applyState();
      }
    </script>
  </body>
</html>
