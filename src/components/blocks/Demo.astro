---
import Container from "../ui/Container.astro";
import Section from "../ui/Section.astro";
import { demoResetIfRequested } from "../../lib/demoReset";
demoResetIfRequested();

---

<Section id="demo" class="demo-stage">
  <Container>
    <div id="demo-root" class="demo-root" data-lead-endpoint="/api/lead"></div>
  </Container>
</Section>

<style>
  .demo-stage {
    min-height: calc(100vh - 72px);
    padding-block: 0 var(--space-16);
    background: linear-gradient(to bottom, #ffffff 0 44%, #03060b 44% 100%);
  }

  .demo-root {
    max-width: 52rem;
    margin-inline: auto;
    margin-top: clamp(2.4rem, 7.5vh, 6rem);
    min-height: clamp(520px, 70vh, 760px);
    padding: clamp(1.3rem, 2.8vw, 2.4rem);
    transition: background-color var(--duration-mid) ease, color var(--duration-mid) ease,
      box-shadow var(--duration-mid) ease;
  }

  .demo-root[data-step="context"],
  .demo-root[data-step="scenario"],
  .demo-root[data-step="signals"] {
    background: #ffffff;
    color: #08101b;
    box-shadow: 0 20px 80px rgba(2, 6, 10, 0.13);
  }

  .demo-root[data-step="analyzing"],
  .demo-root[data-step="result"],
  .demo-root[data-step="already"] {
    background: #02050a;
    color: #f4f8fd;
    box-shadow: 0 26px 92px rgba(0, 0, 0, 0.42);
  }

  .demo-step,
  .demo-result,
  .demo-already {
    max-width: 44rem;
    margin-inline: auto;
  }

  .demo-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 4.5vw, 4.25rem);
    line-height: 0.93;
    letter-spacing: -0.03em;
    margin-bottom: var(--space-5);
  }

  .demo-subtitle {
    font-size: clamp(1rem, 1.6vw, 1.24rem);
    line-height: 1.6;
    max-width: 38ch;
    color: rgba(8, 16, 27, 0.78);
    margin-bottom: var(--space-3);
  }

  .demo-note {
    font-size: 0.84rem;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: rgba(8, 16, 27, 0.6);
    margin-bottom: var(--space-8);
  }

  .demo-field,
  .demo-question {
    margin-bottom: var(--space-5);
  }

  .demo-field label,
  .demo-question label {
    display: block;
    font-size: 0.9rem;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    margin-bottom: var(--space-2);
  }

  .demo-field input,
  .demo-field select {
    width: 100%;
    padding: 0.75rem 0;
    font-size: 1rem;
    border: none;
    border-bottom: 1px solid rgba(8, 16, 27, 0.3);
    background: transparent;
    color: #08101b;
    border-radius: 0;
  }

  .demo-field input:focus-visible,
  .demo-field select:focus-visible {
    outline: none;
    border-bottom-color: rgba(8, 16, 27, 0.9);
  }

  .demo-scenario-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .demo-scenario-option {
    width: 100%;
    text-align: left;
    border: none;
    border-bottom: 1px solid rgba(8, 16, 27, 0.22);
    background: transparent;
    color: #08101b;
    padding: 0 0 var(--space-3);
    cursor: pointer;
    transition: border-color var(--duration-fast) ease, transform var(--duration-fast) ease;
  }

  .demo-scenario-option:hover,
  .demo-scenario-option[aria-pressed="true"] {
    border-bottom-color: rgba(8, 16, 27, 0.82);
    transform: translateX(4px);
  }

  .demo-scenario-title {
    font-family: var(--font-display);
    font-size: clamp(1.2rem, 2.2vw, 1.9rem);
    line-height: 1.05;
    letter-spacing: -0.016em;
    margin-bottom: var(--space-2);
  }

  .demo-scenario-hint {
    font-size: 0.96rem;
    color: rgba(8, 16, 27, 0.72);
    line-height: 1.5;
  }

  .demo-root .demo-toggle-group {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .demo-root .demo-toggle {
    min-height: 40px;
    padding: 0 var(--space-3);
    border: 1px solid rgba(8, 16, 27, 0.24);
    background: transparent;
    color: #08101b;
    font-size: 0.92rem;
    cursor: pointer;
    transition: border-color var(--duration-fast) ease, background var(--duration-fast) ease;
  }

  .demo-root .demo-toggle[aria-pressed="true"] {
    border-color: rgba(8, 16, 27, 0.9);
    background: rgba(8, 16, 27, 0.08);
  }

  .demo-error {
    font-size: 0.88rem;
    color: #9d1f1f;
    margin: var(--space-3) 0;
  }

  .demo-warning {
    font-size: 0.86rem;
    color: rgba(8, 16, 27, 0.68);
    margin: var(--space-3) 0;
  }

  .demo-root[data-step="result"] .demo-warning,
  .demo-root[data-step="analyzing"] .demo-warning,
  .demo-root[data-step="already"] .demo-warning {
    color: rgba(244, 248, 253, 0.66);
  }

  .is-hidden {
    display: none !important;
  }

  .demo-root .demo-submit {
    margin-top: var(--space-8);
    min-height: 46px;
    padding: 0 var(--space-6);
    border: 1px solid currentColor;
    background: #08101b;
    color: #ffffff;
    font-size: 0.92rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    cursor: pointer;
    transition: opacity var(--duration-fast) ease, transform var(--duration-fast) ease;
  }

  .demo-root .demo-submit:hover:not([disabled]) {
    opacity: 0.94;
    transform: translateY(-1px);
  }

  .demo-root .demo-submit[disabled] {
    opacity: 0.48;
    cursor: not-allowed;
  }

  .demo-root[data-step="result"] .demo-submit,
  .demo-root[data-step="analyzing"] .demo-submit,
  .demo-root[data-step="already"] .demo-submit {
    background: #ffffff;
    color: #03060b;
  }

  .demo-root .demo-analyzing {
    text-align: center;
    padding: var(--space-20) 0;
    font-family: var(--font-display);
    font-size: clamp(1.9rem, 3.8vw, 3.6rem);
    line-height: 0.94;
    letter-spacing: -0.02em;
  }

  .demo-how {
    margin-top: var(--space-10);
    padding-top: var(--space-6);
    border-top: 1px solid rgba(244, 248, 253, 0.24);
  }

  .demo-how h3 {
    font-size: 0.82rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: var(--space-3);
    color: rgba(244, 248, 253, 0.74);
  }

  .demo-how p {
    font-size: 0.95rem;
    line-height: 1.62;
    color: rgba(244, 248, 253, 0.82);
    margin-bottom: var(--space-2);
  }

  .demo-cta-sub {
    margin-top: var(--space-4);
    font-size: 0.72rem;
    letter-spacing: 0.11em;
    text-transform: uppercase;
    color: rgba(244, 248, 253, 0.7);
  }

  .demo-root .demo-result-line {
    opacity: 0;
    font-family: var(--font-display);
    font-size: clamp(1.45rem, 3vw, 2.5rem);
    line-height: 0.98;
    letter-spacing: -0.02em;
    padding: var(--space-4) 0;
    transition: opacity 360ms ease;
  }

  .demo-root .demo-result-line.visible {
    opacity: 1;
  }

  .demo-root .demo-already {
    text-align: center;
    padding: var(--space-20) 0;
  }

  .demo-root .demo-already h3 {
    font-family: var(--font-display);
    font-size: clamp(1.9rem, 3.8vw, 3.8rem);
    line-height: 0.94;
    margin-bottom: var(--space-4);
  }

  .demo-root .demo-already p {
    color: rgba(244, 248, 253, 0.76);
  }

  @media (max-width: 700px) {
    .demo-stage {
      min-height: calc(100vh - 62px);
      background: linear-gradient(to bottom, #ffffff 0 38%, #03060b 38% 100%);
    }

    .demo-root {
      margin-top: var(--space-8);
      min-height: 0;
      padding: var(--space-6) var(--space-5);
    }

    .demo-root .demo-toggle-group {
      flex-direction: column;
      align-items: stretch;
    }

    .demo-root .demo-toggle {
      width: 100%;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .demo-scenario-option,
    .demo-root .demo-submit,
    .demo-root .demo-result-line {
      transition: none;
    }
  }
</style>

<script>
  import { demo } from "../../content/demo";
  import {
    evaluateDecision,
    type DemoScenario,
    type SignalA,
    type SignalB,
  } from "../../lib/demoEngine";
  import { createFingerprint, saveFingerprint } from "../../lib/demoFingerprint";

  const EXECUTED_KEY = "aurora_demo_executed";
  const FINGERPRINT_KEY = "aurora_demo_fingerprint";
  const SESSION_KEY = "aurora_demo_session_id";
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const FREE_DOMAINS = new Set(["gmail.com", "yahoo.com", "hotmail.com", "outlook.com"]);

  function emit(name: string) {
    try {
      window.dispatchEvent(new CustomEvent(name, { detail: {} }));
    } catch {}
  }

  function hide(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.add("is-hidden");
  }

  function show(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.remove("is-hidden");
  }

  function domainFromEmail(email: string): string {
    return email.toLowerCase().split("@")[1] ?? "";
  }

  function getSessionId(): string {
    try {
      const existing = localStorage.getItem(SESSION_KEY);
      if (existing) return existing;
      const created = `s_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
      localStorage.setItem(SESSION_KEY, created);
      return created;
    } catch {
      return `s_${Date.now()}`;
    }
  }

  function renderAlreadyExecuted(root: HTMLElement) {
    root.innerHTML = `
      <div class="demo-already">
        <h3>${demo.executed.title}</h3>
        <p>${demo.executed.sub}</p>
      </div>
    `;
  }

  async function sendLead(endpoint: string, lead: Record<string, string>): Promise<boolean> {
    if (!endpoint) return false;
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lead),
      });
      if (!res.ok) return false;
      const json = await res.json().catch(() => null);
      return Boolean(json?.ok === true);
    } catch {
      return false;
    }
  }

  function render(
    root: HTMLElement,
    state: "context" | "scenario" | "signals" | "analyzing" | "result" | "already",
    data?: {
      lead?: {
        name: string;
        company: string;
        country: string;
        industry: string;
        size: string;
        emailDomain: string;
        ts: string;
        sessionId: string;
      };
      scenario?: DemoScenario;
      signalA?: SignalA;
      signalB?: SignalB;
      lines?: [string, string, string];
    }
  ) {
    root.dataset.step = state;

    if (state === "already") {
      renderAlreadyExecuted(root);
      return;
    }

    if (state === "context") {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.context.title}</h2>
          <p class="demo-subtitle">${demo.context.subtitle}</p>
          <p class="demo-note">${demo.context.note}</p>

          <div class="demo-field">
            <label>${demo.context.fields.name}</label>
            <input id="demo-name" type="text" />
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.company}</label>
            <input id="demo-company" type="text" />
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.country}</label>
            <select id="demo-country">
              <option value="">Seleccionar</option>
              ${demo.context.countries.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.industry}</label>
            <select id="demo-industry">
              <option value="">Seleccionar</option>
              ${demo.context.industries.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.size}</label>
            <select id="demo-size">
              <option value="">Seleccionar</option>
              ${demo.context.sizes.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.email}</label>
            <input id="demo-email" type="email" />
          </div>

          <p class="demo-error is-hidden" id="demo-context-error"></p>
          <p class="demo-warning is-hidden" id="demo-context-warning"></p>
          <button type="button" class="demo-submit" id="demo-context-submit">${demo.continue}</button>
        </div>
      `;

      const err = root.querySelector("[id='demo-context-error']") as HTMLElement;
      const warn = root.querySelector("[id='demo-context-warning']") as HTMLElement;
      root.querySelector("[id='demo-context-submit']")?.addEventListener("click", () => {
        const name = (root.querySelector("[id='demo-name']") as HTMLInputElement)?.value.trim();
        const company = (root.querySelector("[id='demo-company']") as HTMLInputElement)?.value.trim();
        const country = (root.querySelector("[id='demo-country']") as HTMLSelectElement)?.value;
        const industry = (root.querySelector("[id='demo-industry']") as HTMLSelectElement)?.value;
        const size = (root.querySelector("[id='demo-size']") as HTMLSelectElement)?.value;
        const email = (root.querySelector("[id='demo-email']") as HTMLInputElement)?.value.trim();

        if (!name || !company || !country || !industry || !size || !email) {
          err.textContent = demo.validation.required;
          show(err);
          return;
        }
        if (!EMAIL_REGEX.test(email)) {
          err.textContent = demo.validation.email;
          show(err);
          return;
        }
        hide(err);
        const emailDomain = domainFromEmail(email);
        if (FREE_DOMAINS.has(emailDomain)) {
          warn.textContent = demo.validation.corporate;
          show(warn);
        } else {
          hide(warn);
        }
        emit("demo_started");
        emit("demo_step1_completed");
        emit("email_submitted");
        const ts = String(Date.now());
        const sessionId = getSessionId();
        render(root, "scenario", {
          lead: { name, company, country, industry, size, emailDomain, ts, sessionId },
        });
      });
      return;
    }

    if (state === "scenario" && data?.lead) {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.scenario.title}</h2>
          <div class="demo-scenario-list">
            ${demo.scenario.options
              .map(
                (item) => `
              <button type="button" class="demo-scenario-option" data-scenario="${item.id}" aria-pressed="false">
                <div class="demo-scenario-title">${item.title}</div>
                <div class="demo-scenario-hint">${item.hint}</div>
              </button>
            `
              )
              .join("")}
          </div>
          <p class="demo-error is-hidden" id="demo-scenario-error">${demo.validation.required}</p>
          <button type="button" class="demo-submit" id="demo-scenario-submit">${demo.continue}</button>
        </div>
      `;
      let selected: DemoScenario | null = null;
      root.querySelectorAll(".demo-scenario-option").forEach((optionEl) => {
        optionEl.addEventListener("click", () => {
          selected = optionEl.getAttribute("data-scenario") as DemoScenario;
          root
            .querySelectorAll(".demo-scenario-option")
            .forEach((item) => item.setAttribute("aria-pressed", "false"));
          optionEl.setAttribute("aria-pressed", "true");
        });
      });
      const err = root.querySelector("[id='demo-scenario-error']") as HTMLElement;
      root.querySelector("[id='demo-scenario-submit']")?.addEventListener("click", () => {
        if (!selected) {
          show(err);
          return;
        }
        hide(err);
        render(root, "signals", { lead: data.lead, scenario: selected });
      });
      return;
    }

    if (state === "signals" && data?.lead && data.scenario) {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.signals.title}</h2>

          <div class="demo-question">
            <label>${demo.signals.a.label}</label>
            <div class="demo-toggle-group">
              <button type="button" class="demo-toggle" data-signal-a="late-collection" aria-pressed="false">${demo.signals.a.options[0]}</button>
              <button type="button" class="demo-toggle" data-signal-a="early-collection" aria-pressed="false">${demo.signals.a.options[1]}</button>
            </div>
          </div>

          <div class="demo-question">
            <label>${demo.signals.b.label}</label>
            <div class="demo-toggle-group">
              <button type="button" class="demo-toggle" data-signal-b="quality-time" aria-pressed="false">${demo.signals.b.options[0]}</button>
              <button type="button" class="demo-toggle" data-signal-b="control-visibility" aria-pressed="false">${demo.signals.b.options[1]}</button>
            </div>
          </div>

          <p class="demo-error is-hidden" id="demo-signals-error">${demo.validation.required}</p>
          <button type="button" class="demo-submit" id="demo-signals-submit">${demo.continue}</button>
        </div>
      `;
      let signalA: SignalA | null = null;
      let signalB: SignalB | null = null;
      root.querySelectorAll("[data-signal-a]").forEach((btn) => {
        btn.addEventListener("click", () => {
          signalA = btn.getAttribute("data-signal-a") as SignalA;
          root.querySelectorAll("[data-signal-a]").forEach((item) => item.setAttribute("aria-pressed", "false"));
          btn.setAttribute("aria-pressed", "true");
        });
      });
      root.querySelectorAll("[data-signal-b]").forEach((btn) => {
        btn.addEventListener("click", () => {
          signalB = btn.getAttribute("data-signal-b") as SignalB;
          root.querySelectorAll("[data-signal-b]").forEach((item) => item.setAttribute("aria-pressed", "false"));
          btn.setAttribute("aria-pressed", "true");
        });
      });
      const err = root.querySelector("[id='demo-signals-error']") as HTMLElement;
      root.querySelector("[id='demo-signals-submit']")?.addEventListener("click", () => {
        if (!signalA || !signalB) {
          show(err);
          return;
        }
        hide(err);
        render(root, "analyzing", { lead: data.lead, scenario: data.scenario, signalA, signalB });
        setTimeout(() => {
          const evaluated = evaluateDecision({
            country: data.lead!.country,
            industry: data.lead!.industry,
            size: data.lead!.size,
            scenario: data.scenario!,
            signalA,
            signalB,
          });
          const ts = Date.now();
          const fp = createFingerprint(
            {
              country: data.lead!.country,
              industry: data.lead!.industry,
              size: data.lead!.size,
              scenario: data.scenario!,
              signalA,
              signalB,
            },
            ts
          );
          saveFingerprint(fp);
          try {
            localStorage.setItem(EXECUTED_KEY, "1");
            localStorage.setItem(FINGERPRINT_KEY, fp);
          } catch {}
          emit("demo_result_viewed");
          render(root, "result", {
            lead: data.lead,
            lines: [evaluated.line1, evaluated.line2, evaluated.line3],
          });
        }, 900);
      });
      return;
    }

    if (state === "analyzing") {
      root.innerHTML = `<div class="demo-analyzing">${demo.analyzing}</div>`;
      return;
    }

    if (state === "result" && data?.lines) {
      const endpoint = (root.dataset.leadEndpoint ?? "").trim();
      const endpointReady = endpoint.length > 0;
      root.innerHTML = `
        <div class="demo-result">
          <h2 class="demo-title">${demo.result.title}</h2>
          <p class="demo-result-line" data-line="0">${data.lines[0]}</p>
          <p class="demo-result-line" data-line="1">${data.lines[1]}</p>
          <p class="demo-result-line" data-line="2">${data.lines[2]}</p>
          <div class="demo-how">
            <h3>${demo.result.howTitle}</h3>
            <p>${demo.result.howLine1}</p>
            <p>${demo.result.howLine2}</p>
          </div>
          <button type="button" class="demo-submit" id="demo-talk" ${endpointReady ? "" : "disabled"}>
            ${endpointReady ? demo.result.cta : demo.result.ctaUnavailable}
          </button>
          <p class="demo-warning is-hidden" id="demo-submit-warning">${demo.result.ctaUnavailable}</p>
          ${endpointReady ? "" : `<p class="demo-warning">${demo.validation.endpointMissing}</p>`}
          <p class="demo-cta-sub">${demo.result.ctaSub}</p>
        </div>
      `;
      const lines = root.querySelectorAll(".demo-result-line");
      const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const delay = reduceMotion ? 0 : 520;
      lines.forEach((el, i) => {
        setTimeout(() => {
          el.classList.add("visible");
        }, reduceMotion ? 0 : i * delay);
      });

      const submitButton = root.querySelector("[id=demo-talk]") as HTMLButtonElement | null;
      let leadSubmitting = false;

      submitButton?.addEventListener("click", async () => {
        if (!endpointReady || !data.lead || leadSubmitting) return;
        const warning = root.querySelector("[id=demo-submit-warning]") as HTMLElement | null;
        hide(warning);
        leadSubmitting = true;
        submitButton.disabled = true;
        emit("lead_submit_started");

        const sent = await sendLead(endpoint, {
          source: "aurora-site",
          name: data.lead.name,
          company: data.lead.company,
          country: data.lead.country,
          industry: data.lead.industry,
          email_domain: data.lead.emailDomain,
          session_id: data.lead.sessionId,
        });

        if (!sent) {
          emit("lead_submit_failed");
          show(warning);
          leadSubmitting = false;
          submitButton.disabled = false;
          return;
        }

        emit("lead_submitted");
        emit("lead_submit_success");
        window.location.href = "/#contacto";
      });

      return;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const root = document.getElementById("demo-root");
    if (!root) return;
    try {
      if (localStorage.getItem(EXECUTED_KEY) === "1" || localStorage.getItem(EXECUTED_KEY) === "true") {
        render(root, "already");
        return;
      }
    } catch {}
    render(root, "context");
  });
</script>
