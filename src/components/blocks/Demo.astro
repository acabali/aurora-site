---
import Container from "../ui/Container.astro";
import Section from "../ui/Section.astro";
---

<Section id="demo" class="block-demo-wrap">
  <Container>
    <div id="demo-root" class="demo-root" data-lead-endpoint="/api/lead"></div>
  </Container>
</Section>

<style>
  .block-demo-wrap {
    padding-block: var(--space-16);
    border-top: 1px solid var(--line);
  }
  .demo-root {
    max-width: 36rem;
    margin-inline: auto;
    border: 1px solid var(--line);
    border-radius: var(--radius-md);
    background: var(--bg-1);
    padding: var(--space-8);
    box-shadow: var(--shadow-sm);
  }
  .demo-title {
    font-size: var(--text-2xl);
    line-height: var(--lh-tight);
    margin-bottom: var(--space-4);
  }
  .demo-subtitle {
    color: var(--text-1);
    line-height: var(--lh-body);
    margin-bottom: var(--space-3);
  }
  .demo-note {
    color: var(--text-1);
    font-size: var(--text-sm);
    margin-bottom: var(--space-8);
  }
  .demo-field {
    margin-bottom: var(--space-5);
  }
  .demo-field label,
  .demo-question label {
    display: block;
    font-size: var(--text-sm);
    color: var(--text-0);
    margin-bottom: var(--space-2);
    line-height: var(--lh-body);
  }
  .demo-field input,
  .demo-field select {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    border: 1px solid var(--line);
    border-radius: var(--radius-md);
    background: var(--bg-2);
    color: var(--text-0);
  }
  .demo-field input:focus-visible,
  .demo-field select:focus-visible {
    outline: 2px solid rgba(37, 99, 235, 0.85);
    outline-offset: 1px;
  }
  .demo-question {
    margin-bottom: var(--space-6);
  }
  .demo-scenario-list {
    display: grid;
    gap: var(--space-4);
  }
  .demo-scenario-card {
    border: 1px solid var(--line);
    border-radius: var(--radius-md);
    padding: var(--space-5);
    cursor: pointer;
    background: var(--bg-2);
    transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
  }
  .demo-scenario-card:hover {
    transform: translateY(-1px);
    border-color: rgba(255, 255, 255, 0.3);
  }
  .demo-scenario-card[aria-pressed="true"] {
    border-color: var(--accent);
    background: rgba(37, 99, 235, 0.14);
  }
  .demo-scenario-title {
    font-size: var(--text-sm);
    line-height: var(--lh-body);
    margin-bottom: var(--space-2);
  }
  .demo-scenario-hint {
    color: var(--text-1);
    font-size: var(--text-sm);
  }
  .demo-root .demo-toggle-group {
    display: flex;
    gap: var(--space-3);
  }
  .demo-root .demo-toggle {
    min-height: 44px;
    padding: 0 var(--space-4);
    font-size: var(--text-sm);
    border: 1px solid var(--line);
    background: var(--bg-2);
    color: var(--text-0);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: border-color 0.2s, background 0.2s;
  }
  .demo-root .demo-toggle[aria-pressed="true"] {
    border-color: var(--accent);
    background: rgba(37, 99, 235, 0.14);
  }
  .demo-root .demo-toggle:focus-visible {
    outline: 2px solid rgba(37, 99, 235, 0.85);
    outline-offset: 2px;
  }
  .demo-error {
    font-size: var(--text-sm);
    color: #ffb3b3;
    margin: var(--space-2) 0 var(--space-3);
  }
  .demo-warning {
    font-size: var(--text-sm);
    color: var(--text-1);
    margin: var(--space-2) 0 var(--space-3);
  }
  .is-hidden {
    display: none !important;
  }
  .demo-root .demo-submit {
    margin-top: var(--space-8);
    min-height: 46px;
    padding: 0 var(--space-6);
    font-size: var(--text-sm);
    font-weight: 500;
    border: 1px solid var(--text-0);
    background: var(--text-0);
    color: var(--bg-0);
    cursor: pointer;
    border-radius: var(--radius-md);
    width: 100%;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .demo-root .demo-submit:hover:not([disabled]) {
    opacity: 0.96;
    transform: translateY(-1px);
  }
  .demo-root .demo-submit:focus-visible {
    outline: 2px solid rgba(37, 99, 235, 0.85);
    outline-offset: 2px;
  }
  .demo-root .demo-submit[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .demo-root .demo-analyzing {
    text-align: center;
    color: var(--text-1);
    font-size: var(--text-sm);
    padding: var(--space-12) 0;
  }
  .demo-how {
    margin-top: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid var(--border);
  }
  .demo-how h3 {
    font-size: var(--text-base);
    margin-bottom: var(--space-3);
  }
  .demo-how p {
    font-size: var(--text-sm);
    line-height: var(--lh-body);
    color: var(--text-1);
    margin-bottom: var(--space-2);
  }
  .demo-cta-sub {
    color: var(--text-1);
    font-size: var(--text-sm);
    margin-top: var(--space-3);
  }
  .demo-root .demo-result-line {
    opacity: 0;
    padding: var(--space-4) 0;
    font-size: var(--text-base);
    line-height: var(--lh-body);
    color: var(--text-0);
    transition: opacity 0.4s ease;
  }
  .demo-root .demo-result-line.visible {
    opacity: 1;
  }
  .demo-root .demo-already {
    text-align: center;
    padding: var(--space-12) 0;
  }
  .demo-root .demo-already h3 {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-3);
    color: var(--fg);
  }
  .demo-root .demo-already p {
    font-size: var(--text-sm);
    color: var(--text-1);
  }
  @media (prefers-reduced-motion: reduce) {
    .demo-scenario-card,
    .demo-root .demo-submit {
      transition: none;
    }
  }
  @media (max-width: 640px) {
    .demo-root {
      padding: var(--space-6) var(--space-5);
    }
  }
</style>

<script>
  import { demo } from "../../content/demo";
  import {
    evaluateDecision,
    type DemoScenario,
    type SignalA,
    type SignalB,
  } from "../../lib/demoEngine";
  import { createFingerprint, saveFingerprint } from "../../lib/demoFingerprint";

  const EXECUTED_KEY = "aurora_demo_executed";
  const FINGERPRINT_KEY = "aurora_demo_fingerprint";
  const SESSION_KEY = "aurora_demo_session_id";
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const FREE_DOMAINS = new Set(["gmail.com", "yahoo.com", "hotmail.com", "outlook.com"]);

  function emit(name: string) {
    try {
      window.dispatchEvent(new CustomEvent(name, { detail: {} }));
    } catch {}
  }

  function hide(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.add("is-hidden");
  }

  function show(el: HTMLElement | null): void {
    if (!el) return;
    el.classList.remove("is-hidden");
  }

  function domainFromEmail(email: string): string {
    return email.toLowerCase().split("@")[1] ?? "";
  }

  function getSessionId(): string {
    try {
      const existing = localStorage.getItem(SESSION_KEY);
      if (existing) return existing;
      const created = `s_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
      localStorage.setItem(SESSION_KEY, created);
      return created;
    } catch {
      return `s_${Date.now()}`;
    }
  }

  function renderAlreadyExecuted(root: HTMLElement) {
    root.innerHTML = `
      <div class="demo-already">
        <h3>${demo.executed.title}</h3>
        <p>${demo.executed.sub}</p>
      </div>
    `;
  }

  async function sendLead(endpoint: string, lead: Record<string, string>): Promise<boolean> {
    if (!endpoint) return false;
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lead),
      });
      if (!res.ok) return false;
      const json = await res.json().catch(() => null);
      return Boolean(json?.ok === true);
    } catch {
      return false;
    }
  }

  function render(
    root: HTMLElement,
    state: "context" | "scenario" | "signals" | "analyzing" | "result" | "already",
    data?: {
      lead?: {
        name: string;
        company: string;
        country: string;
        industry: string;
        size: string;
        emailDomain: string;
        ts: string;
        sessionId: string;
      };
      scenario?: DemoScenario;
      signalA?: SignalA;
      signalB?: SignalB;
      lines?: [string, string, string];
    }
  ) {
    if (state === "already") {
      renderAlreadyExecuted(root);
      return;
    }

    if (state === "context") {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.context.title}</h2>
          <p class="demo-subtitle">${demo.context.subtitle}</p>
          <p class="demo-note">${demo.context.note}</p>

          <div class="demo-field">
            <label>${demo.context.fields.name}</label>
            <input id="demo-name" type="text" />
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.company}</label>
            <input id="demo-company" type="text" />
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.country}</label>
            <select id="demo-country">
              <option value="">Seleccionar</option>
              ${demo.context.countries.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.industry}</label>
            <select id="demo-industry">
              <option value="">Seleccionar</option>
              ${demo.context.industries.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.size}</label>
            <select id="demo-size">
              <option value="">Seleccionar</option>
              ${demo.context.sizes.map((v) => `<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>
          <div class="demo-field">
            <label>${demo.context.fields.email}</label>
            <input id="demo-email" type="email" />
          </div>

          <p class="demo-error is-hidden" id="demo-context-error"></p>
          <p class="demo-warning is-hidden" id="demo-context-warning"></p>
          <button type="button" class="demo-submit" id="demo-context-submit">${demo.continue}</button>
        </div>
      `;

      const err = root.querySelector("[id='demo-context-error']") as HTMLElement;
      const warn = root.querySelector("[id='demo-context-warning']") as HTMLElement;
      root.querySelector("[id='demo-context-submit']")?.addEventListener("click", () => {
        const name = (root.querySelector("[id='demo-name']") as HTMLInputElement)?.value.trim();
        const company = (root.querySelector("[id='demo-company']") as HTMLInputElement)?.value.trim();
        const country = (root.querySelector("[id='demo-country']") as HTMLSelectElement)?.value;
        const industry = (root.querySelector("[id='demo-industry']") as HTMLSelectElement)?.value;
        const size = (root.querySelector("[id='demo-size']") as HTMLSelectElement)?.value;
        const email = (root.querySelector("[id='demo-email']") as HTMLInputElement)?.value.trim();

        if (!name || !company || !country || !industry || !size || !email) {
          err.textContent = demo.validation.required;
          show(err);
          return;
        }
        if (!EMAIL_REGEX.test(email)) {
          err.textContent = demo.validation.email;
          show(err);
          return;
        }
        hide(err);
        const emailDomain = domainFromEmail(email);
        if (FREE_DOMAINS.has(emailDomain)) {
          warn.textContent = demo.validation.corporate;
          show(warn);
        } else {
          hide(warn);
        }
        emit("demo_started");
        emit("demo_step1_completed");
        emit("email_submitted");
        const ts = String(Date.now());
        const sessionId = getSessionId();
        render(root, "scenario", {
          lead: { name, company, country, industry, size, emailDomain, ts, sessionId },
        });
      });
      return;
    }

    if (state === "scenario" && data?.lead) {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.scenario.title}</h2>
          <div class="demo-scenario-list">
            ${demo.scenario.options
              .map(
                (item) => `
              <button type="button" class="demo-scenario-card" data-scenario="${item.id}" aria-pressed="false">
                <div class="demo-scenario-title">${item.title}</div>
                <div class="demo-scenario-hint">${item.hint}</div>
              </button>
            `
              )
              .join("")}
          </div>
          <p class="demo-error is-hidden" id="demo-scenario-error">${demo.validation.required}</p>
          <button type="button" class="demo-submit" id="demo-scenario-submit">${demo.continue}</button>
        </div>
      `;
      let selected: DemoScenario | null = null;
      root.querySelectorAll(".demo-scenario-card").forEach((card) => {
        card.addEventListener("click", () => {
          selected = card.getAttribute("data-scenario") as DemoScenario;
          root
            .querySelectorAll(".demo-scenario-card")
            .forEach((c) => c.setAttribute("aria-pressed", "false"));
          card.setAttribute("aria-pressed", "true");
        });
      });
      const err = root.querySelector("[id='demo-scenario-error']") as HTMLElement;
      root.querySelector("[id='demo-scenario-submit']")?.addEventListener("click", () => {
        if (!selected) {
          show(err);
          return;
        }
        hide(err);
        render(root, "signals", { lead: data.lead, scenario: selected });
      });
      return;
    }

    if (state === "signals" && data?.lead && data.scenario) {
      root.innerHTML = `
        <div class="demo-step">
          <h2 class="demo-title">${demo.signals.title}</h2>

          <div class="demo-question">
            <label>${demo.signals.a.label}</label>
            <div class="demo-toggle-group">
              <button type="button" class="demo-toggle" data-signal-a="late-collection" aria-pressed="false">${demo.signals.a.options[0]}</button>
              <button type="button" class="demo-toggle" data-signal-a="early-collection" aria-pressed="false">${demo.signals.a.options[1]}</button>
            </div>
          </div>

          <div class="demo-question">
            <label>${demo.signals.b.label}</label>
            <div class="demo-toggle-group">
              <button type="button" class="demo-toggle" data-signal-b="quality-time" aria-pressed="false">${demo.signals.b.options[0]}</button>
              <button type="button" class="demo-toggle" data-signal-b="control-visibility" aria-pressed="false">${demo.signals.b.options[1]}</button>
            </div>
          </div>

          <p class="demo-error is-hidden" id="demo-signals-error">${demo.validation.required}</p>
          <button type="button" class="demo-submit" id="demo-signals-submit">${demo.continue}</button>
        </div>
      `;
      let signalA: SignalA | null = null;
      let signalB: SignalB | null = null;
      root.querySelectorAll("[data-signal-a]").forEach((btn) => {
        btn.addEventListener("click", () => {
          signalA = btn.getAttribute("data-signal-a") as SignalA;
          root.querySelectorAll("[data-signal-a]").forEach((b) => b.setAttribute("aria-pressed", "false"));
          btn.setAttribute("aria-pressed", "true");
        });
      });
      root.querySelectorAll("[data-signal-b]").forEach((btn) => {
        btn.addEventListener("click", () => {
          signalB = btn.getAttribute("data-signal-b") as SignalB;
          root.querySelectorAll("[data-signal-b]").forEach((b) => b.setAttribute("aria-pressed", "false"));
          btn.setAttribute("aria-pressed", "true");
        });
      });
      const err = root.querySelector("[id='demo-signals-error']") as HTMLElement;
      root.querySelector("[id='demo-signals-submit']")?.addEventListener("click", () => {
        if (!signalA || !signalB) {
          show(err);
          return;
        }
        hide(err);
        render(root, "analyzing", { lead: data.lead, scenario: data.scenario, signalA, signalB });
        setTimeout(() => {
          const evaluated = evaluateDecision({
            country: data.lead!.country,
            industry: data.lead!.industry,
            size: data.lead!.size,
            scenario: data.scenario!,
            signalA,
            signalB,
          });
          const ts = Date.now();
          const fp = createFingerprint(
            {
              country: data.lead!.country,
              industry: data.lead!.industry,
              size: data.lead!.size,
              scenario: data.scenario!,
              signalA,
              signalB,
            },
            ts
          );
          saveFingerprint(fp);
          try {
            localStorage.setItem(EXECUTED_KEY, "1");
            localStorage.setItem(FINGERPRINT_KEY, fp);
          } catch {}
          emit("demo_result_viewed");
          render(root, "result", {
            lead: data.lead,
            lines: [evaluated.line1, evaluated.line2, evaluated.line3],
          });
        }, 900);
      });
      return;
    }

    if (state === "analyzing") {
      root.innerHTML = `<div class="demo-analyzing">${demo.analyzing}</div>`;
      return;
    }

    if (state === "result" && data?.lines) {
      const endpoint = (root.dataset.leadEndpoint ?? "").trim();
      const endpointReady = endpoint.length > 0;
      root.innerHTML = `
        <div class="demo-result">
          <h2 class="demo-title">${demo.result.title}</h2>
          <p class="demo-result-line" data-line="0">${data.lines[0]}</p>
          <p class="demo-result-line" data-line="1">${data.lines[1]}</p>
          <p class="demo-result-line" data-line="2">${data.lines[2]}</p>
          <div class="demo-how">
            <h3>${demo.result.howTitle}</h3>
            <p>${demo.result.howLine1}</p>
            <p>${demo.result.howLine2}</p>
          </div>
          <button type="button" class="demo-submit" id="demo-talk" ${endpointReady ? "" : "disabled"}>
            ${endpointReady ? demo.result.cta : demo.result.ctaUnavailable}
          </button>
          <p class="demo-warning is-hidden" id="demo-submit-warning">${demo.result.ctaUnavailable}</p>
          ${endpointReady ? "" : `<p class="demo-warning">${demo.validation.endpointMissing}</p>`}
          <p class="demo-cta-sub">${demo.result.ctaSub}</p>
        </div>
      `;
      const lines = root.querySelectorAll(".demo-result-line");
      const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const delay = reduceMotion ? 0 : 600;
      lines.forEach((el, i) => {
        setTimeout(() => {
          el.classList.add("visible");
        }, reduceMotion ? 0 : i * delay);
      });

      const submitButton = root.querySelector("[id=demo-talk]") as HTMLButtonElement | null;
      let leadSubmitting = false;

      submitButton?.addEventListener("click", async () => {
        if (!endpointReady || !data.lead || leadSubmitting) return;
        const warning = root.querySelector("[id=demo-submit-warning]") as HTMLElement | null;
        hide(warning);
        leadSubmitting = true;
        submitButton.disabled = true;
        emit("lead_submit_started");

        const sent = await sendLead(endpoint, {
          source: "aurora-site",
          name: data.lead.name,
          company: data.lead.company,
          country: data.lead.country,
          industry: data.lead.industry,
          email_domain: data.lead.emailDomain,
          session_id: data.lead.sessionId,
        });

        if (!sent) {
          emit("lead_submit_failed");
          show(warning);
          leadSubmitting = false;
          submitButton.disabled = false;
          return;
        }

        emit("lead_submitted");
        emit("lead_submit_success");
        window.location.href = "/#contacto";
      });

      return;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const root = document.getElementById("demo-root");
    if (!root) return;
    try {
      if (localStorage.getItem(EXECUTED_KEY) === "1" || localStorage.getItem(EXECUTED_KEY) === "true") {
        render(root, "already");
        return;
      }
    } catch {}
    render(root, "context");
  });
</script>
